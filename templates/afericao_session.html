{% extends 'base.html' %}

{% block content %}
<input type="hidden" id="sessionId" value="{{ session_id }}">

<!-- ROOM HEADER -->
<div class="card card-field mb-3">
    <div class="card-body py-2 d-flex justify-content-between align-items-center">
        <div>
            <small class="text-muted d-block">SALA</small>
            <strong class="fs-3 text-primary">{{ session_id }}</strong>
        </div>
        <div class="text-end">
            <small class="text-muted d-block">USUÁRIOS</small>
            <span class="badge bg-secondary" id="userCount">...</span>
        </div>
    </div>
</div>

<!-- IDENTITY SELECTOR (Only shown initially) -->
<div id="identityStep" class="card card-field">
    <div class="card-body text-center p-5">
        <h4 class="mb-4">Quem é você?</h4>
        <div class="d-grid gap-3">
            <button class="btn btn-outline-primary btn-lg py-4" onclick="selectUser('A')">
                <i class="fas fa-user-hard-hat fa-2x d-block mb-2"></i> Técnico A (Instalado)
            </button>
            <button class="btn btn-outline-success btn-lg py-4" onclick="selectUser('B')">
                <i class="fas fa-clipboard-check fa-2x d-block mb-2"></i> Técnico B (Mala)
            </button>
        </div>
    </div>
</div>

<!-- WAITING FOR START -->
<div id="waitingStep" class="d-none text-center mt-5">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <h3 class="mt-3">Aguardando Início...</h3>
    <button id="startBtn" class="btn btn-warning btn-lg mt-4 px-5 fw-bold shadow">
        <i class="fas fa-play"></i> INICIAR TODOS
    </button>
</div>

<!-- ACTIVE TEST UI -->
<div id="testStep" class="d-none">
    
    <!-- COUNTDOWN OVERLAY -->
    <div id="countdownOverlay" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark d-flex align-items-center justify-content-center" style="z-index: 2000; opacity: 0.95;">
        <h1 class="text-white display-1 fw-bold" id="countdownText">3</h1>
    </div>

    <div class="card card-field border-primary">
        <div class="card-header-field bg-primary text-center">
            TEMPO DECORRIDO
        </div>
        <div class="card-body text-center py-5">
            <h1 class="display-1 fw-bold font-monospace" id="mainTimer">00:00</h1>
            <p class="text-muted lead">Próxima Leitura: <span id="nextReadingTimer">60s</span></p>
        </div>
    </div>

    <div class="card card-field mt-3">
        <div class="card-header bg-light">Leituras Registradas (<span id="readingsCount">0</span>/10)</div>
        <ul class="list-group list-group-flush" id="readingsList">
            <!-- Items added here -->
        </ul>
    </div>
</div>

<!-- RESULTS SCREEN -->
<div id="resultStep" class="d-none">
    <div class="card card-field text-center p-4">
        <h2 class="mb-3">Resultado Final</h2>
        <div id="statusCard" class="alert p-4 mb-4">
            <h1 class="fw-bold m-0" id="finalStatus">...</h1>
        </div>
        
        <div class="row text-center mb-4">
            <div class="col-6">
                <small class="text-muted">Média A</small>
                <div class="fs-4" id="avgA"></div>
            </div>
            <div class="col-6">
                <small class="text-muted">Média B</small>
                <div class="fs-4" id="avgB"></div>
            </div>
            <div class="col-12 mt-3">
                <small class="text-muted">Erro Percentual</small>
                <div class="fs-2 fw-bold" id="finalError"></div>
            </div>
        </div>

        <a href="/" class="btn btn-outline-secondary">Voltar ao Menu</a>
        
        <hr class="my-4">
        
        <!-- K-FACTOR CORRECTOR -->
        <div class="card bg-light border-primary">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-sliders-h me-2"></i> Correção de Fator K
            </div>
            <div class="card-body">
                <p class="small text-muted">
                    O sistema assume que o <strong>Técnico A (Medidor)</strong> está errado e o <strong>Técnico B (Mala)</strong> é a referência correta.
                </p>
                <div class="mb-3">
                    <label class="form-label fw-bold">Qual o Fator K atual do medidor?</label>
                    <input type="number" id="currentK" class="form-control form-control-lg text-center" placeholder="Ex: 1.000" step="0.0001">
                </div>
                <button class="btn btn-primary w-100" onclick="calcNewK()">
                    Calcular Novo Fator K
                </button>
                
                <div id="kResult" class="mt-3 d-none animate-fade-in">
                    <h5 class="text-muted">Novo Fator K Sugerido:</h5>
                    <div class="display-4 fw-bold text-success" id="newKVal">...</div>
                    <p class="small text-muted mt-2" id="kExplanation">...</p>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- INPUT MODAL -->
<div class="modal fade" id="inputModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title fw-bold text-dark"><i class="fas fa-edit"></i> REGISTRAR LEITURA #<span id="modalMinute"></span></h5>
            </div>
            <div class="modal-body p-4">
                <label class="form-label lead">Valor em m³/h (ou L/s):</label>
                <input type="number" id="readingValue" class="form-control form-control-lg border-warning" inputmode="decimal" step="0.01">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-lg btn-primary w-100" onclick="submitValue()">Salvar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const sessionId = document.getElementById('sessionId').value;
let userRole = null;
let startTime = null;
let currentMinute = 1;
let intervalId = null;
let syncInterval = null;
let sessionInterval = 60; // Default
let finalAvgA = 0;
let finalAvgB = 0;

// Audio context for alerts
const audioContext = new (window.AudioContext || window.webkitAudioContext)();

function beep() {
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    oscillator.type = 'square';
    oscillator.frequency.value = 800; // Hz
    gainNode.gain.value = 0.5;
    oscillator.start();
    setTimeout(() => oscillator.stop(), 200);
}

function selectUser(role) {
    userRole = role;
    document.getElementById('identityStep').classList.add('d-none');
    document.getElementById('waitingStep').classList.remove('d-none');
    startSync();
}

document.getElementById('startBtn').addEventListener('click', async () => {
    await fetch('/api/start_test', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ session_id: sessionId })
    });
});

function startSync() {
    syncInterval = setInterval(async () => {
        try {
            const res = await fetch(`/api/session_status/${sessionId}`);
            const data = await res.json();
            
            // Update UI counts (optional polish)
            document.getElementById('userCount').textContent = `A: ${data.count_a} | B: ${data.count_b}`;

            if(data.start_time && !startTime) {
                // Test has started!
                startTime = data.start_time; // This is a unix timestamp (seconds)
                if(data.interval) sessionInterval = data.interval;
                beginTest();
            }
        } catch(e) { console.error(e); }
    }, 1000);
}

function beginTest() {
    clearInterval(syncInterval);
    document.getElementById('waitingStep').classList.add('d-none');
    document.getElementById('testStep').classList.remove('d-none');
    
    // Start local loop
    intervalId = setInterval(gameLoop, 100);
}

function gameLoop() {
    const now = Date.now() / 1000;
    const diff = now - startTime;

    // PRE-START COUNTDOWN (negative diff)
    if (diff < 0) {
        document.getElementById('countdownOverlay').classList.remove('d-none');
        const secondsLeft = Math.ceil(Math.abs(diff));
        document.getElementById('countdownText').textContent = secondsLeft > 0 ? secondsLeft : "VAI!";
        return;
    } 
    
    // START
    document.getElementById('countdownOverlay').classList.add('d-none');
    
    // Format timer
    const minutes = Math.floor(diff / 60);
    const seconds = Math.floor(diff % 60);
    document.getElementById('mainTimer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    // Logic for alerts (based on sessionInterval)
    const nextMinuteMark = currentMinute * sessionInterval;
    const timeToNext = nextMinuteMark - diff;
    
    document.getElementById('nextReadingTimer').textContent = Math.ceil(timeToNext) + "s";

    if (timeToNext <= 0) {
        // Trigger Input
        triggerInput(currentMinute);
        currentMinute++;
    }

    // End condition (after 10 minutes)
    if (currentMinute > 10) {
        finishTest();
    }
}

let modalObj = null;

function triggerInput(min) {
    // Vibrate and Beep
    if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
    beep();

    document.getElementById('modalMinute').textContent = min;
    document.getElementById('readingValue').value = '';
    
    const modalEl = document.getElementById('inputModal');
    modalObj = new bootstrap.Modal(modalEl);
    modalObj.show();
}

async function submitValue() {
    const val = document.getElementById('readingValue').value;
    if(!val) return;
    
    const min = document.getElementById('modalMinute').textContent;
    
    // Add to list visually
    const li = document.createElement('li');
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    li.innerHTML = `Minuto ${min} <span class="badge bg-primary rounded-pill">${val}</span>`;
    document.getElementById('readingsList').prepend(li);
    document.getElementById('readingsCount').textContent = document.getElementById('readingsList').children.length;

    // Send to backend
    await fetch('/api/submit_reading', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            session_id: sessionId,
            user: userRole,
            minute: parseInt(min),
            value: val
        })
    });

    modalObj.hide();
}

async function finishTest() {
    clearInterval(intervalId);
    document.getElementById('testStep').classList.add('d-none');
    document.getElementById('resultStep').classList.remove('d-none');
    document.getElementById('finalStatus').textContent = "Calculando...";
    
    // Fetch final results
    const res = await fetch(`/api/get_results/${sessionId}`);
    const data = await res.json();
    
    document.getElementById('avgA').textContent = data.avg_a;
    document.getElementById('avgB').textContent = data.avg_b;
    document.getElementById('finalError').textContent = data.error_pct + "%";
    document.getElementById('finalStatus').textContent = data.status;
    
    const statusCard = document.getElementById('statusCard');
    if(data.status === 'APROVADO') {
        statusCard.classList.remove('alert-danger');
        statusCard.classList.add('alert-success');
    } else {
        statusCard.classList.add('alert-danger');
    }
    
    // Store for K Calc
    finalAvgA = data.avg_a;
    finalAvgB = data.avg_b;
}

function calcNewK() {
    const currentK = parseFloat(document.getElementById('currentK').value);
    if(!currentK || finalAvgA === 0) return;
    
    // Logic: New K = Current K * (Ref / Meter)
    // Ref = B, Meter = A
    const ratio = finalAvgB / finalAvgA;
    const newK = currentK * ratio;
    
    document.getElementById('kResult').classList.remove('d-none');
    document.getElementById('newKVal').textContent = newK.toFixed(5);
    
    const diff = ((finalAvgA - finalAvgB) / finalAvgB) * 100;
    document.getElementById('kExplanation').innerHTML = 
        `O medidor estava lendo <strong>${Math.abs(diff).toFixed(2)}%</strong> ${diff > 0 ? "a mais" : "a menos"} que a referência.`;
}
</script>
{% endblock %}
